# _     _            _        _          _____
#| |__ | | __ _  ___| | _____| | ___   _|___ /
#| '_ \| |/ _` |/ __| |/ / __| |/ / | | | |_ \
#| |_) | | (_| | (__|   <\__ \   <| |_| |___) |
#|_.__/|_|\__,_|\___|_|\_\___/_|\_\\__, |____/
#                                  |___/

#Maintainer: blacksky3 <blacksky3@tuta.io> <https://github.com/blacksky3>
#Credits:  Bart≈Çomiej Piotrowski <bpiotrowski@archlinux.org>
#Credits: Allan McRae <allan@archlinux.org>
#Credits: judd <jvinet@zeroflux.org>

# NOTE: requires rebuilt with each new gcc version

pkgname=lib32-libltdl-git
pkgver=2.4.6.r63.gf5eb6f11
pkgrel=1
_gccver=8.2.1
pkgdesc='A generic library support script (32-bit) (git version)'
arch=(x86_64)
url='https://www.gnu.org/software/libtool'
license=(GPL)
groups=(multilib-devel)
depends=(sh tar lib32-glibc libtool)
makedepends=("gcc>=$_gccver" git help2man)
checkdepends=(gcc-fortran)
provides=("lib32-libtool=${pkgver}" lib32-libltdl lib32-libltdl-git "lib32-libltdl=${pkgver}" "lib32-libltdl-git=${pkgver}"
          lib32-libtool lib32-libtool-git "lib32-libtool-git=$pkgver")
conflicts=(lib32-libtool lib32-libltdl)
replaces=(lib32-libtool)
source=(git+https://git.savannah.gnu.org/git/libtool.git
        git+https://git.savannah.gnu.org/git/gnulib.git
        gnulib-bootstrap::git+https://github.com/gnulib-modules/bootstrap.git)
sha256sums=(SKIP
            SKIP
            SKIP)

pkgver(){
  cd ${srcdir}/libtool

  # cutting off 'foo-' prefix that presents in the git tag
  #git describe --long | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'

  #git describe --long | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
  #git describe --long --tags | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare(){
  cd ${srcdir}/libtool

  git submodule init
  git config --local submodule.gnulib.url "$srcdir/gnulib"
  git config --local submodule.gl-mod/bootstrap.url "$srcdir/gnulib-bootstrap"
  git submodule update

  ./bootstrap
}

build(){
  export CC="gcc -m32" CXX="g++ -m32"

  cd ${srcdir}/libtool
  ./configure --prefix=/usr lt_cv_sys_lib_dlsearch_path_spec="/usr/lib /usr/lib32" --libdir=/usr/lib32
  make -j$(nproc)
}

check(){
  cd ${srcdir}/libtool
  make -j$(nproc) check gl_public_submodule_commit= || :
}

package(){
  cd ${srcdir}/libtool
  make -j$(nproc) DESTDIR="$pkgdir" install-libLTLIBRARIES
}
